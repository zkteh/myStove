<!DOCTYPE html>
	<html lang="en">
	<head>
	    <meta charset="UTF-8">
	    <title>myStove-FYP</title>
	    <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/css/bootstrap.min.css" rel="stylesheet">
	    <link href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.css" rel="stylesheet">
	</head>
	<body>
	<div class="container">
	    <div class="row">
	        <div class="col-12">
	            <div class="card">
	                <div class="card-body">
	                    <canvas id="canvas"></canvas>
	                </div>
	            </div>
	        </div>
	    </div>
	</div>
	
	<p>timestamp : <span id="timestamp"></span></p>
	<p>ds18b20 : <span id="ds18b20"></span></p>
	<p>mlx_ambient : <span id="mlx_ambient"></span></p>
	<p>mlx_object : <span id="mlx_object"></span></p>
	<p>mlx_object_avg_over1min : <span id="mlx_object_avg"></span></p>
	<p>Status:  <span id="status"></span></p>
	<p>Latest temperature : <span id="temperature"></span></p>
	<p>Previous temperature : <span id="last_value"></span></p>
	
	<!--suppress JSUnresolvedLibraryURL -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
	<!--suppress JSUnresolvedLibraryURL -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
	<!--suppress JSUnresolvedLibraryURL -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.8.0/Chart.min.js"></script>
		
	<script>
	    $(document).ready(function () {	        	        	     
	        const config = {
	            type: 'line',
	            data: {
	                labels: [],
	                datasets: [{
	                    label: "ds18b20",
	                    backgroundColor: 'rgb(255, 99, 132)',
	                    borderColor: 'rgb(255, 99, 132)',
	                    data: [],
	                    fill: false,
	                }, {
	                    label: "mlx_ambient",
	                    backgroundColor: 'rgb(97, 171, 64)',
	                    borderColor: 'rgb(97, 171, 64)',
	                    data: [],
	                    fill: false,
	                }, {
	                    label: "mlx_object",
	                    backgroundColor: 'rgb(0, 168, 255)',
	                    borderColor: 'rgb(0, 168, 255)',
	                    data: [],
	                    fill: false,
					},{
	                    label: "mlx_object_avg",
	                    backgroundColor: 'rgb(159, 51, 255)',
	                    borderColor: 'rgb(159, 51, 255)',
	                    data: [],
	                    fill: false,
	                }],
	            },
	            options: {
	                responsive: true,
	                title: {
	                    display: true,
	                    text: 'Creating Real-Time Charts with Flask'
	                },
	                tooltips: {
	                    mode: 'index',
	                    intersect: false,
	                },
	                hover: {
	                    mode: 'nearest',
	                    intersect: true
	                },
	                scales: {
	                    xAxes: [{
	                        display: true,
	                        scaleLabel: {
	                            display: true,
	                            labelString: 'Time'
	                        }
	                    }],
	                    yAxes: [{
	                        display: true,
	                        scaleLabel: {
	                            display: true,
	                            labelString: 'Value'
	                        }
	                    }]
	                }
	            }
	        };
	            
	        const context = document.getElementById('canvas').getContext('2d');
	        const lineChart = new Chart(context, config);
			
			//declare variable
			//var temperature = null;
			//var average = null;

			//insert data from JSON to global variables				
			var timestamp;
			var ds18b20;
			var mlx_ambient;
			var mlx_object;
			var mlx_object_avg;
	                            
	        //var jsonurl = "/data";
	        function fetchData(){    //this function will run 3 sec, with setInterval
	            $.getJSON('/data', function (data) {   
					
					//declare var for easy usage
					timestamp = data.c[0][0];
					ds18b20 = data.c[0][1];
					mlx_ambient = data.c[0][2];
					mlx_object = data.c[0][3];
					mlx_object_avg = data.d[0][0];

					//force update data
					//if (temperature == null){
					//	temperature = mlx_object;
					//	average = mlx_object_avg;
					//}
			
	              // for (var i=0; i < data.length; i++){                
	                //shift the old data to make the graph nicer
	                if (config.data.labels.length === 60) {    
	                    config.data.labels.shift();
	                    config.data.datasets[0].data.shift();
	                    config.data.datasets[1].data.shift();
						config.data.datasets[2].data.shift();
						config.data.datasets[3].data.shift();
					}
					
	                //insert data to graph   
	                config.data.labels.push(timestamp); 
	                config.data.datasets[0].data.push(ds18b20); 
	                config.data.datasets[1].data.push(mlx_ambient); 
					config.data.datasets[2].data.push(mlx_object); 
					config.data.datasets[3].data.push(mlx_object_avg); 
	                lineChart.update();
	
					//update current value on web
					document.getElementById("timestamp").textContent = timestamp;  
	                document.getElementById("ds18b20").textContent = ds18b20;
	                document.getElementById("mlx_ambient").textContent = mlx_ambient;
					document.getElementById("mlx_object").textContent = mlx_object; 
					document.getElementById("mlx_object_avg").textContent = mlx_object_avg.toFixed(2);
					document.getElementById("temperature").textContent = temperature;
					document.getElementById("last_value").textContent = last_value; 				

				   //}//end of for loop()  
				  

				   dataProcessing();
				   

	            }); //end of $.getJSON()
	         }//end of fetchdata()
			
			 //loop to get new data
	        $(document).ready(function(){
	           setInterval(fetchData,3000);
			});    

			var last_value = null;
			var arr = [];

			function dataProcessing(){
					
				var last_on = timestamp;		//insert data
				var temperature = mlx_object;
				var average = mlx_object_avg;
								
				if (last_value == null){		
					last_value = 0;
				} 				
		
				console.log("");			
				console.log("temperature (mlx_object) : " + temperature);
				console.log("last value : " + last_value);
				console.log("last_on : " + last_on);
				console.log("");
									
				//last_value = temperature;		//insert previous temperature to last_value, 
				
				arr.push(temperature);
				last_value = arr[arr.length - 10];
				console.log("last 10th value " + last_value);


				var array_last_10 = arr.slice(-10);
				console.log(array_last_10);	
				var max = Math.max(...array_last_10);
				var min = Math.min(...array_last_10);
			
				console.log("MAX number from the last 10 " + max);
				console.log("MIN number from the last 10 " + min);
				
				//and compare last_value & latest temperature using the logic below														
				if (temperature < 35){
					console.log("OFF : Less than 35");
					//return ("OFF", "none");	
				}

				//Temperature went down by 3 degrees
				if (last_value - temperature >= 3){
				console.log("GAS ON: temperature went UP by 3");
				//return ("MAYBE", "none")
				}
																
					
				//Temperature went down by 3 degrees
				if (last_value - temperature >= 3){
					console.log("GAS OFF: temperature went DOWN by 3");
					//return ("MAYBE", "none")
				}

				if (temperature <= average && last_value > temperature && max > temperature){
					console.log("COOLING DOWN: temperature decreasing");
					//return ("MAYBE", "none")s
				}

				if (temperature >= average && temperature > min){
					console.log("WARMING UP: temperature increasing");
					//return ("MAYBE", "none")
				}


							
			} //end of dataProcess 
			
			
	                       
	    }); //end of ready()
	    
	</script>
	</body>
	</html>
